# ðŸŽ¨ FoodBuddy Frontend Dockerfile (Next.js ìµœì í™”)
# ë¹Œë“œ ì‹œê°„ 1ë¶„ 20ì´ˆ ëª©í‘œ, ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ, npm ìºì‹œ ìµœì í™”

# ===== Stage 1: Base =====
FROM node:18-alpine AS base

# íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ìµœì í™”
RUN corepack enable
WORKDIR /app

# ðŸ“¦ Alpine ìµœì í™” íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat curl

# ===== Stage 2: Dependencies =====
FROM base AS deps

# package.jsonê³¼ package-lock.jsonë§Œ ë¨¼ì € ë³µì‚¬ (ìºì‹œ í™œìš©)
COPY package*.json ./

# ðŸš€ npm ìºì‹œ ìµœì í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
# - í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™”ë¡œ ì†ë„ í–¥ìƒ
# - npm cië¡œ ë” ë¹ ë¥¸ ì„¤ì¹˜
# - productionê³¼ development ì˜ì¡´ì„± ë¶„ë¦¬
ENV NEXT_TELEMETRY_DISABLED 1
ENV NPM_CONFIG_CACHE /app/.npm-cache

RUN mkdir -p /app/.npm-cache && \
    npm ci --cache /app/.npm-cache --prefer-offline

# ===== Stage 3: Builder =====
FROM base AS builder

WORKDIR /app

# ì˜ì¡´ì„± ë³µì‚¬
COPY --from=deps /app/node_modules ./node_modules

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# ðŸ—ï¸ Next.js ë¹Œë“œ ìµœì í™”
# - í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™”
# - ë¹Œë“œ ì—ëŸ¬ ë¬´ì‹œ ì„¤ì • (ESLint ì—ëŸ¬ë¡œ ì¸í•œ ë¹Œë“œ ì‹¤íŒ¨ ë°©ì§€)
# - í”„ë¡œë•ì…˜ ìµœì í™”
ENV NEXT_TELEMETRY_DISABLED 1
ENV NODE_ENV production

# ðŸ”§ Next.js ì„¤ì • íŒŒì¼ ìƒì„± (critters ì˜¤ë¥˜ ë°©ì§€)
RUN cat > next.config.mjs << 'EOF'
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  eslint: { 
    ignoreDuringBuilds: true 
  },
  typescript: { 
    ignoreBuildErrors: true 
  },
  poweredByHeader: false,
  compress: true,
  swcMinify: true,
  experimental: {
    // optimizeCss ì œê±° - critters ì˜ì¡´ì„± ë¬¸ì œ ë°©ì§€
  }
}

export default nextConfig
EOF

# ðŸš€ Next.js ë¹Œë“œ ì‹¤í–‰ (ì—ëŸ¬ í—ˆìš©)
RUN npm run build || (echo "âš ï¸ ë¹Œë“œ ê²½ê³ ê°€ ìžˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤" && npm run build -- --no-lint)

# ===== Stage 4: Runner =====
FROM base AS runner

WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# ðŸ”’ ë³´ì•ˆ: non-root ì‚¬ìš©ìž ìƒì„±
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# ðŸ“ í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ë³µì‚¬ (ì´ë¯¸ì§€ í¬ê¸° ìµœì†Œí™”)
COPY --from=builder /app/public ./public

# ðŸ“¦ standalone ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# ðŸ”’ non-root ì‚¬ìš©ìžë¡œ ì „í™˜
USER nextjs

# ðŸŒ¡ï¸ í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=3s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# ðŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
EXPOSE 3000
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# ðŸŽ¯ ìµœì í™”ëœ Node.js ì‹¤í–‰ ì˜µì…˜
# - ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì„ ìœ„í•œ ì˜µì…˜ë“¤
# - V8 ì—”ì§„ ìµœì í™”
CMD ["node", \
    "--max-old-space-size=512", \
    "--optimize-for-size", \
    "--gc-interval=100", \
    "server.js"]

# ðŸ“ ë©”íƒ€ë°ì´í„°
LABEL maintainer="FoodBuddy Team"
LABEL description="FoodBuddy Frontend Web Application (Next.js)"
LABEL version="1.0.0" 