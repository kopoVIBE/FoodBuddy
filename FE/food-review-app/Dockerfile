# ğŸ¨ FoodBuddy Frontend Dockerfile (Next.js ìµœì í™”)
# ë¹Œë“œ ì‹œê°„ 1ë¶„ 20ì´ˆ ëª©í‘œ, ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ, npm ìºì‹œ ìµœì í™”

# ===== Stage 1: Base =====
FROM node:18-alpine AS base

# íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ìµœì í™”
RUN corepack enable
WORKDIR /app

# ğŸ“¦ Alpine ìµœì í™” íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apk add --no-cache libc6-compat curl

# ===== Stage 2: Dependencies =====
FROM base AS deps

# package.jsonê³¼ package-lock.jsonë§Œ ë¨¼ì € ë³µì‚¬ (ìºì‹œ í™œìš©)
COPY package*.json ./

# ğŸš€ npm ìºì‹œ ìµœì í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
# - í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™”ë¡œ ì†ë„ í–¥ìƒ
# - npm cië¡œ ë” ë¹ ë¥¸ ì„¤ì¹˜
# - productionê³¼ development ì˜ì¡´ì„± ë¶„ë¦¬
ENV NEXT_TELEMETRY_DISABLED 1
ENV NPM_CONFIG_CACHE /app/.npm-cache

RUN mkdir -p /app/.npm-cache && \
    npm ci --cache /app/.npm-cache --prefer-offline

# ===== Stage 3: Builder =====
FROM base AS builder

WORKDIR /app

# ì˜ì¡´ì„± ë³µì‚¬
COPY --from=deps /app/node_modules ./node_modules

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# ğŸ—ï¸ Next.js ë¹Œë“œ ìµœì í™”
# - í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™”
# - ë¹Œë“œ ì—ëŸ¬ ë¬´ì‹œ ì„¤ì • (ESLint ì—ëŸ¬ë¡œ ì¸í•œ ë¹Œë“œ ì‹¤íŒ¨ ë°©ì§€)
# - í”„ë¡œë•ì…˜ ìµœì í™”
ENV NEXT_TELEMETRY_DISABLED 1
ENV NODE_ENV production

# ğŸ”§ Next.js ì„¤ì • íŒŒì¼ ìƒì„± (critters ì˜¤ë¥˜ ë°©ì§€)
RUN echo "const nextConfig = {" > next.config.mjs && \
    echo "  output: 'standalone'," >> next.config.mjs && \
    echo "  eslint: { ignoreDuringBuilds: true }," >> next.config.mjs && \
    echo "  typescript: { ignoreBuildErrors: true }," >> next.config.mjs && \
    echo "  poweredByHeader: false," >> next.config.mjs && \
    echo "  compress: true," >> next.config.mjs && \
    echo "  swcMinify: true" >> next.config.mjs && \
    echo "};" >> next.config.mjs && \
    echo "" >> next.config.mjs && \
    echo "export default nextConfig;" >> next.config.mjs

# ğŸš€ Next.js ë¹Œë“œ ì‹¤í–‰ (ì—ëŸ¬ í—ˆìš©)
RUN npm run build || (echo "âš ï¸ ë¹Œë“œ ê²½ê³ ê°€ ìˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤" && npm run build -- --no-lint)

# ===== Stage 4: Runner =====
FROM base AS runner

WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# ğŸ”’ ë³´ì•ˆ: non-root ì‚¬ìš©ì ìƒì„±
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# ğŸ“ í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ë³µì‚¬ (ì´ë¯¸ì§€ í¬ê¸° ìµœì†Œí™”)
COPY --from=builder /app/public ./public

# ğŸ“¦ standalone ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# ğŸ”’ non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER nextjs

# ğŸŒ¡ï¸ í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=3s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3000 || exit 1

# ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
EXPOSE 3000
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# ğŸ¯ ìµœì í™”ëœ Node.js ì‹¤í–‰ ì˜µì…˜
# - ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì„ ìœ„í•œ ì˜µì…˜ë“¤
# - V8 ì—”ì§„ ìµœì í™”
CMD ["node", \
    "--max-old-space-size=512", \
    "--optimize-for-size", \
    "--gc-interval=100", \
    "server.js"]

# ğŸ“ ë©”íƒ€ë°ì´í„°
LABEL maintainer="FoodBuddy Team"
LABEL description="FoodBuddy Frontend Web Application (Next.js)"
LABEL version="1.0.0" 