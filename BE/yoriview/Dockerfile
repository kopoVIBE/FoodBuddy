# ğŸ—ï¸ FoodBuddy Backend Dockerfile (Spring Boot ìµœì í™”)
# ë¹Œë“œ ì‹œê°„ 25ì´ˆ ëª©í‘œ, í…ŒìŠ¤íŠ¸ ì œì™¸, ì˜ì¡´ì„± ìºì‹œ ìµœì í™”

# ===== Stage 1: Dependencies =====
FROM eclipse-temurin:17-jdk-alpine AS dependencies

WORKDIR /app

# Alpine íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
RUN apk add --no-cache bash

# Gradle Wrapperì™€ ì„¤ì • íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (ìºì‹œ í™œìš©)
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .

# gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x ./gradlew

# ì˜ì¡´ì„±ë§Œ ë¨¼ì € ë‹¤ìš´ë¡œë“œ (ìºì‹œ ë ˆì´ì–´ ìƒì„±)
RUN ./gradlew dependencies --no-daemon

# ===== Stage 2: Build =====
FROM dependencies AS builder

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src src

# ìµœì í™”ëœ ë¹Œë“œ ì‹¤í–‰
# - í…ŒìŠ¤íŠ¸ ì™„ì „ ì œì™¸ (assemble ì‚¬ìš©)
# - ë³‘ë ¬ ë¹Œë“œ í™œì„±í™”
# - ë¹Œë“œ ìºì‹œ í™œìš©
# - ë°ëª¬ ë¹„í™œì„±í™” (ë©”ëª¨ë¦¬ ì ˆì•½)
RUN ./gradlew clean assemble \
    --parallel \
    --build-cache \
    --no-daemon \
    -x test

# ===== Stage 3: Runtime =====
FROM eclipse-temurin:17-jre-alpine AS runtime

# ğŸ”’ ë³´ì•ˆ: non-root ì‚¬ìš©ì ìƒì„± (Alpine ë°©ì‹)
RUN addgroup -g 1001 -S foodbuddy && \
    adduser -u 1001 -S foodbuddy -G foodbuddy

# ğŸ“ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /app

# ğŸƒâ€â™‚ï¸ ëŸ°íƒ€ì„ ìµœì í™”ë¥¼ ìœ„í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Alpine ë°©ì‹)
RUN apk add --no-cache \
    curl \
    bash

# ğŸ“¦ ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/build/libs/*.jar app.jar

# ğŸ“ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN mkdir -p /app/logs && chown -R foodbuddy:foodbuddy /app

# ğŸ”’ non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER foodbuddy

# ğŸŒ¡ï¸ í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
# JVM ìµœì í™” ì˜µì…˜:
# - ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì„ ìœ„í•œ G1GC ì‚¬ìš©
# - ì»¨í…Œì´ë„ˆ í™˜ê²½ì— ë§ëŠ” ë©”ëª¨ë¦¬ ì„¤ì •
# - ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œê°„ ë‹¨ì¶•ì„ ìœ„í•œ ì˜µì…˜ë“¤
EXPOSE 8080

ENTRYPOINT ["java", \
    "-server", \
    "-XX:+UseG1GC", \
    "-XX:+UseContainerSupport", \
    "-XX:MaxRAMPercentage=75.0", \
    "-XX:+OptimizeStringConcat", \
    "-XX:+UseStringDeduplication", \
    "-Djava.security.egd=file:/dev/./urandom", \
    "-Dspring.profiles.active=prod", \
    "-jar", "app.jar"]

# ğŸ“ ë©”íƒ€ë°ì´í„°
LABEL maintainer="FoodBuddy Team"
LABEL description="FoodBuddy Backend API Server (Spring Boot)"
LABEL version="1.0.0" 